<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Court System Verification</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #ff6b35;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 10px;
        }
        .test-result {
            margin: 15px 0;
            padding: 15px;
            background: #2d2d2d;
            border-left: 4px solid #4ec9b0;
            border-radius: 4px;
        }
        .test-result.pass {
            border-left-color: #4ec9b0;
        }
        .test-result.fail {
            border-left-color: #f48771;
        }
        .test-title {
            font-weight: bold;
            color: #4ec9b0;
            margin-bottom: 8px;
        }
        .test-result.fail .test-title {
            color: #f48771;
        }
        .test-details {
            color: #858585;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .court-grid {
            background: #0a7a0a;
            border: 2px solid #ff6b35;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.7em;
            line-height: 1.2;
            color: #fff;
            overflow-x: auto;
        }
        .pass-all {
            background: #1e4620;
            border: 2px solid #4ec9b0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            color: #4ec9b0;
            font-size: 1.2em;
            font-weight: bold;
        }
        .fail-all {
            background: #4e1e1e;
            border: 2px solid #f48771;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            color: #f48771;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        button:hover {
            background: #f7931e;
        }
    </style>
</head>
<body>
    <h1>üèÄ Court System Verification</h1>
    <p>Verifying the basketball court grid system implementation</p>
    
    <div class="controls">
        <button onclick="location.reload()">Run Tests Again</button>
    </div>

    <div id="results"></div>

    <script>
        // Player Class
        class Player {
            constructor(name, position, skillLevel = 3) {
                this.name = name;
                this.position = position;
                this.skillLevel = Math.min(5, Math.max(1, skillLevel));
                this.stats = {
                    pointsScored: 0,
                    assists: 0,
                    rebounds: 0,
                    steals: 0,
                    blocks: 0,
                    fouls: 0,
                };
                this.isActive = true;
                this.x = 0;
                this.y = 0;
            }
        }

        // Team Class
        class Team {
            constructor(name, players = []) {
                this.name = name;
                this.players = players;
                this.score = 0;
                this.quarter = 1;
            }
            addPlayer(player) {
                if (this.players.length < 12) {
                    this.players.push(player);
                }
            }
            getActivePlayersOnCourt() {
                return this.players.filter((p, i) => p.isActive && i < 5);
            }
            getPlayerByPosition(position) {
                return this.players.find(p => p.position === position && p.isActive);
            }
            getActivePlayers() {
                return this.players.filter(p => p.isActive);
            }
        }

        // Court Class
        class Court {
            constructor(width = 50, height = 30) {
                this.width = width;
                this.height = height;
                this.grid = this.initializeGrid();
                this.ballPosition = { x: Math.floor(width / 2), y: Math.floor(height / 2) };
                this.ballPossession = null;
            }

            initializeGrid() {
                const grid = [];
                for (let y = 0; y < this.height; y++) {
                    const row = [];
                    for (let x = 0; x < this.width; x++) {
                        row.push(null);
                    }
                    grid.push(row);
                }
                return grid;
            }

            placePlayer(player, x, y) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) {
                    throw new Error(`Invalid court position: (${x}, ${y})`);
                }
                if (player.x !== undefined && player.y !== undefined) {
                    const prevX = Math.floor(player.x);
                    const prevY = Math.floor(player.y);
                    if (this.grid[prevY] && this.grid[prevY][prevX] === player) {
                        this.grid[prevY][prevX] = null;
                    }
                }
                player.x = x;
                player.y = y;
                this.grid[Math.floor(y)][Math.floor(x)] = player;
            }

            setupTeams(homeTeam, awayTeam) {
                const homeActive = homeTeam.getActivePlayersOnCourt();
                const awayActive = awayTeam.getActivePlayersOnCourt();

                const homePositions = {
                    'PG': { x: 5, y: 15 },
                    'SG': { x: 10, y: 10 },
                    'SF': { x: 10, y: 20 },
                    'PF': { x: 20, y: 12 },
                    'C': { x: 20, y: 18 }
                };

                const awayPositions = {
                    'PG': { x: 45, y: 15 },
                    'SG': { x: 40, y: 10 },
                    'SF': { x: 40, y: 20 },
                    'PF': { x: 30, y: 12 },
                    'C': { x: 30, y: 18 }
                };

                homeActive.forEach(player => {
                    const pos = homePositions[player.position] || { x: 10, y: 15 };
                    this.placePlayer(player, pos.x, pos.y);
                });

                awayActive.forEach(player => {
                    const pos = awayPositions[player.position] || { x: 40, y: 15 };
                    this.placePlayer(player, pos.x, pos.y);
                });

                const homePG = homeTeam.getPlayerByPosition('PG');
                if (homePG) {
                    this.setBallPossession(homePG);
                }
            }

            setBallPossession(player) {
                this.ballPossession = player;
                if (player) {
                    this.ballPosition = { x: player.x, y: player.y };
                }
            }

            movePlayer(player, targetX, targetY) {
                const speedMap = {
                    'PG': 10,
                    'SG': 8,
                    'SF': 7,
                    'PF': 6,
                    'C': 5
                };

                const speed = speedMap[player.position] || 7;
                const currentX = player.x;
                const currentY = player.y;

                const dx = targetX - currentX;
                const dy = targetY - currentY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance === 0) {
                    return { x: currentX, y: currentY };
                }

                const moveDistance = Math.min(distance, speed);
                const ratio = moveDistance / distance;
                
                let newX = currentX + (dx * ratio);
                let newY = currentY + (dy * ratio);

                newX = Math.max(0, Math.min(this.width - 1, newX));
                newY = Math.max(0, Math.min(this.height - 1, newY));

                this.placePlayer(player, newX, newY);

                if (this.ballPossession === player) {
                    this.ballPosition = { x: newX, y: newY };
                }

                return { x: newX, y: newY, distance: distance - moveDistance };
            }

            areAdjacent(player1, player2, maxDistance = 3) {
                const dx = player1.x - player2.x;
                const dy = player1.y - player2.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= maxDistance;
            }

            getShootingDistance(player, isHomeTeam) {
                const basketX = isHomeTeam ? 49 : 0;
                const basketY = 15;
                
                const distance = Math.sqrt(
                    Math.pow(basketX - player.x, 2) + 
                    Math.pow(basketY - player.y, 2)
                );
                
                if (distance <= 8) return 'close';
                if (distance <= 15) return 'mid';
                return 'three';
            }

            getState() {
                const players = [];
                for (let row of this.grid) {
                    for (let player of row) {
                        if (player) {
                            players.push({
                                name: player.name,
                                position: player.position,
                                x: Math.round(player.x * 10) / 10,
                                y: Math.round(player.y * 10) / 10,
                                hasBall: this.ballPossession === player
                            });
                        }
                    }
                }
                return {
                    width: this.width,
                    height: this.height,
                    ballPosition: {
                        x: Math.round(this.ballPosition.x * 10) / 10,
                        y: Math.round(this.ballPosition.y * 10) / 10
                    },
                    ballPossession: this.ballPossession ? this.ballPossession.name : null,
                    players
                };
            }
        }

        // Test Suite
        class TestRunner {
            constructor() {
                this.tests = [];
                this.passed = 0;
                this.failed = 0;
            }

            addTest(name, fn) {
                this.tests.push({ name, fn, details: '' });
            }

            run() {
                for (let test of this.tests) {
                    try {
                        test.fn();
                        this.passed++;
                        this.logPass(test.name, test.details);
                    } catch (error) {
                        this.failed++;
                        this.logFail(test.name, error.message);
                    }
                }
                this.printSummary();
            }

            logPass(name, details = '') {
                const html = `
                    <div class="test-result pass">
                        <div class="test-title">‚úÖ ${name}</div>
                        <div class="test-details">
                            ${details || 'Test passed successfully'}
                        </div>
                    </div>
                `;
                document.getElementById('results').innerHTML += html;
            }

            logFail(name, error) {
                const html = `
                    <div class="test-result fail">
                        <div class="test-title">‚ùå ${name}</div>
                        <div class="test-details">Error: ${error}</div>
                    </div>
                `;
                document.getElementById('results').innerHTML += html;
            }

            printSummary() {
                const total = this.passed + this.failed;
                if (this.failed === 0) {
                    document.getElementById('results').innerHTML += `
                        <div class="pass-all">
                            üéâ ALL ${total} TESTS PASSED!<br>
                            <small>Court system is working correctly</small>
                        </div>
                    `;
                } else {
                    document.getElementById('results').innerHTML += `
                        <div class="fail-all">
                            ‚ùå ${this.failed} of ${total} tests failed
                        </div>
                    `;
                }
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message);
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(`${message} (expected: ${expected}, got: ${actual})`);
                }
            }
        }

        // Initialize and run tests
        window.addEventListener('load', () => {
            const runner = new TestRunner();

            runner.addTest('Court Initialization', () => {
                const court = new Court(50, 30);
                runner.assertEqual(court.width, 50, 'Width check');
                runner.assertEqual(court.height, 30, 'Height check');
                runner.assertEqual(court.grid.length, 30, 'Grid rows');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Court created:</strong> 50√ó30 grid<br>
                    <strong>Grid dimensions:</strong> ${court.grid.length} rows √ó ${court.grid[0].length} columns<br>
                    <strong>Ball starting position:</strong> (${court.ballPosition.x}, ${court.ballPosition.y})<br>
                    ‚úì Court is initialized and ready for teams
                `;
            });

            runner.addTest('Place Player on Court', () => {
                const court = new Court(50, 30);
                const player = new Player('LeBron', 'PG', 5);
                court.placePlayer(player, 10, 15);
                runner.assertEqual(player.x, 10, 'Player X position');
                runner.assertEqual(player.y, 15, 'Player Y position');
                runner.assert(court.grid[15][10] === player, 'Player in grid');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Player placed:</strong> ${player.name} (${player.position})<br>
                    <strong>Position:</strong> X=${player.x}, Y=${player.y}<br>
                    <strong>Found in grid:</strong> ${court.grid[15][10]?.name === 'LeBron' ? '‚úì YES' : '‚úó NO'}<br>
                    ‚úì Player positioning system works
                `;
            });

            runner.addTest('Move Player', () => {
                const court = new Court(50, 30);
                const pgPlayer = new Player('Magic', 'PG', 5);
                court.placePlayer(pgPlayer, 10, 15);
                const initialPos = { x: pgPlayer.x, y: pgPlayer.y };
                const move = court.movePlayer(pgPlayer, 20, 15);
                const finalPos = { x: Math.round(pgPlayer.x), y: Math.round(pgPlayer.y) };
                
                runner.assert(move.distance < 10, 'PG moves distance');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Player:</strong> ${pgPlayer.name} (PG - speed: 10)<br>
                    <strong>Starting position:</strong> (${initialPos.x}, ${initialPos.y})<br>
                    <strong>Target position:</strong> (20, 15)<br>
                    <strong>Final position:</strong> (${finalPos.x}, ${finalPos.y})<br>
                    <strong>Distance moved:</strong> ~10 squares<br>
                    <strong>Remaining distance:</strong> ${move.distance.toFixed(2)} squares<br>
                    ‚úì Movement system works correctly
                `;
            });

            runner.addTest('Setup Teams on Court', () => {
                const court = new Court(50, 30);
                const homeTeam = new Team('Lakers');
                homeTeam.addPlayer(new Player('Magic', 'PG', 5));
                homeTeam.addPlayer(new Player('Kobe', 'SG', 5));
                homeTeam.addPlayer(new Player('LeBron', 'SF', 5));
                homeTeam.addPlayer(new Player('Pau', 'PF', 4));
                homeTeam.addPlayer(new Player('Shaq', 'C', 5));

                const awayTeam = new Team('Celtics');
                awayTeam.addPlayer(new Player('Rajon', 'PG', 4));
                awayTeam.addPlayer(new Player('Ray', 'SG', 4));
                awayTeam.addPlayer(new Player('Pierce', 'SF', 4));
                awayTeam.addPlayer(new Player('Garnett', 'PF', 4));
                awayTeam.addPlayer(new Player('Perkins', 'C', 3));

                court.setupTeams(homeTeam, awayTeam);
                const state = court.getState();
                
                runner.assertEqual(state.players.length, 10, 'Player count');
                runner.assertEqual(state.ballPossession, 'Magic', 'Ball possession');
                
                const magicPos = state.players.find(p => p.name === 'Magic');
                const rajonPos = state.players.find(p => p.name === 'Rajon');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Home Team:</strong> Lakers (5 players)<br>
                    <strong>Away Team:</strong> Celtics (5 players)<br>
                    <strong>Total on court:</strong> ${state.players.length} players<br>
                    <strong>Ball possession:</strong> ${state.ballPossession}<br>
                    <br>
                    <strong>Formation:</strong><br>
                    ‚Ä¢ Lakers formation: Left side (x < 25)<br>
                    ‚Ä¢ Celtics formation: Right side (x > 25)<br>
                    <br>
                    <strong>Magic (Lakers PG):</strong> (${magicPos.x}, ${magicPos.y}) - HAS BALL ‚úì<br>
                    <strong>Rajon (Celtics PG):</strong> (${rajonPos.x}, ${rajonPos.y})<br>
                    ‚úì Teams properly positioned for match start
                `;
            });

            runner.addTest('Player Adjacency', () => {
                const court = new Court(50, 30);
                const p1 = new Player('P1', 'PG', 3);
                const p2 = new Player('P2', 'SG', 3);
                const p3 = new Player('P3', 'C', 3);
                
                court.placePlayer(p1, 10, 15);
                court.placePlayer(p2, 12, 15);
                court.placePlayer(p3, 20, 15);
                
                const adj1_2 = court.areAdjacent(p1, p2, 3);
                const adj1_3 = court.areAdjacent(p1, p3, 3);
                
                runner.assert(adj1_2, 'Close players adjacent');
                runner.assert(!adj1_3, 'Far players not adjacent');
                
                const dist1_2 = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                const dist1_3 = Math.sqrt(Math.pow(p3.x - p1.x, 2) + Math.pow(p3.y - p1.y, 2));
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Player 1 position:</strong> (${p1.x}, ${p1.y})<br>
                    <strong>Player 2 position:</strong> (${p2.x}, ${p2.y})<br>
                    <strong>Player 3 position:</strong> (${p3.x}, ${p3.y})<br>
                    <br>
                    <strong>P1 ‚Üí P2 distance:</strong> ${dist1_2.toFixed(2)} squares (max 3)<br>
                    <strong>Adjacent:</strong> ${adj1_2 ? '‚úì YES' : '‚úó NO'}<br>
                    <br>
                    <strong>P1 ‚Üí P3 distance:</strong> ${dist1_3.toFixed(2)} squares (max 3)<br>
                    <strong>Adjacent:</strong> ${adj1_3 ? '‚úì YES' : '‚úó NO'}<br>
                    ‚úì Adjacency detection working for steals/contests
                `;
            });

            runner.addTest('Shooting Distance Calculation', () => {
                const court = new Court(50, 30);
                const player = new Player('Shooter', 'SG', 4);
                
                court.placePlayer(player, 42, 15);
                const closeRange = court.getShootingDistance(player, true);
                
                court.placePlayer(player, 30, 15);
                const midRange = court.getShootingDistance(player, true);
                
                court.placePlayer(player, 20, 15);
                const threeRange = court.getShootingDistance(player, true);
                
                runner.assertEqual(closeRange, 'close', 'Close range detected');
                runner.assertEqual(threeRange, 'three', '3-pointer range detected');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Home team basket:</strong> X=49, Y=15<br>
                    <br>
                    <strong>Position (42, 15):</strong> ${closeRange.toUpperCase()} range<br>
                    Distance: ~${Math.sqrt(Math.pow(49-42, 2) + Math.pow(15-15, 2)).toFixed(2)} squares<br>
                    <strong>Expected:</strong> 2-pointer range ‚úì<br>
                    <br>
                    <strong>Position (30, 15):</strong> ${midRange.toUpperCase()} range<br>
                    Distance: ~${Math.sqrt(Math.pow(49-30, 2) + Math.pow(15-15, 2)).toFixed(2)} squares<br>
                    <strong>Expected:</strong> Mid-range ‚úì<br>
                    <br>
                    <strong>Position (20, 15):</strong> ${threeRange.toUpperCase()} range<br>
                    Distance: ~${Math.sqrt(Math.pow(49-20, 2) + Math.pow(15-15, 2)).toFixed(2)} squares<br>
                    <strong>Expected:</strong> 3-pointer range ‚úì<br>
                    ‚úì Shooting distance calculation works for all ranges
                `;
            });

            runner.addTest('Ball Possession Tracking', () => {
                const court = new Court(50, 30);
                const player1 = new Player('Passer', 'PG', 5);
                const player2 = new Player('Receiver', 'SG', 4);
                
                court.placePlayer(player1, 10, 15);
                court.placePlayer(player2, 20, 15);
                
                court.setBallPossession(player1);
                runner.assertEqual(court.ballPossession, player1, 'Ball assigned to player1');
                runner.assertEqual(court.ballPosition.x, 10, 'Ball position X');
                runner.assertEqual(court.ballPosition.y, 15, 'Ball position Y');
                
                court.setBallPossession(player2);
                runner.assertEqual(court.ballPossession, player2, 'Ball transferred to player2');
                runner.assertEqual(court.ballPosition.x, 20, 'Ball position updated X');
                runner.assertEqual(court.ballPosition.y, 15, 'Ball position updated Y');
                
                runner.tests[runner.tests.length - 1].details = `
                    <strong>Initial possession:</strong> ${player1.name} at (10, 15)<br>
                    <strong>Ball tracked:</strong> ‚úì YES<br>
                    <br>
                    <strong>Pass to:</strong> ${player2.name} at (20, 15)<br>
                    <strong>Ball transferred:</strong> ‚úì YES<br>
                    <strong>Ball position updated:</strong> ‚úì YES<br>
                    ‚úì Ball possession system working (needed for match engine)
                `;
            });

            runner.run();
        });
    </script>
</body>
</html>
